# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ SPA

## 1. –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º—ã

### –ò—Å—Ö–æ–¥–Ω—ã–µ –æ—à–∏–±–∫–∏
1. **ERR_CONNECTION_REFUSED** - —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ API –∑–∞–ø—Ä–æ—Å–∞—Ö
2. **–î—É–±–ª–∏—Ä—É—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HashStorage** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `init()`
3. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–ª–æ–∞–¥** - —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –≤—Ö–æ–¥–∞

### –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ì–æ–Ω–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 2.1 –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Global Error Handler                      ‚îÇ
‚îÇ         (window.onerror, window.onunhandledrejection)        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    AuthManager (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ initialize(), login(), logout(), checkAuth()        ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ retry logic, state sync, error handling             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ              ‚îÇ              ‚îÇ
              ‚ñº              ‚ñº              ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   API Client ‚îÇ ‚îÇ   WS Manager ‚îÇ ‚îÇ StateManager ‚îÇ
    ‚îÇ (RetryManager)‚îÇ ‚îÇ  (Reconnect) ‚îÇ ‚îÇ  (Storage)   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ              ‚îÇ              ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                             ‚îÇ
                             ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ    ConnectionManager        ‚îÇ
              ‚îÇ  (online/offline detection) ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 –ü–æ—Ä—è–¥–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```
1. SafeInitializer.check()           - –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
2. StateManager.restore()            - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. ConnectionManager.init()          - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
4. HashStorage.initialize()          - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
5. AuthManager.initialize()          - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
6. WebSocketManager.connect()        - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WS (–ø–æ—Å–ª–µ API auth)
7. AppComponent.render()             - –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```

---

## 3. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 3.1 SafeInitializer

**–§–∞–π–ª**: `public/js/managers/SafeInitializer.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π

```javascript
class SafeInitializer {
    constructor() {
        this._isInitialized = false;
        this._initializationPromise = null;
        this._queue = [];
        this._isInitializing = false;
    }

    async initialize(fn, timeout = 30000) {
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (this._isInitialized && !this._isInitializing) {
            return this._initializationPromise;
        }

        // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        if (this._isInitializing) {
            return this._queue.push(fn), this._initializationPromise;
        }

        this._isInitializing = true;
        
        try {
            this._initializationPromise = this._executeWithTimeout(fn, timeout);
            return await this._initializationPromise;
        } finally {
            this._isInitialized = true;
            this._isInitializing = false;
        }
    }

    schedule(fn) {
        return this._isInitialized 
            ? fn() 
            : this._queue.push(fn) && this._initializationPromise;
    }
}
```

### 3.2 RetryManager

**–§–∞–π–ª**: `public/js/managers/RetryManager.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

```javascript
class RetryManager {
    constructor(options = {}) {
        this.maxRetries = options.maxRetries || 3;
        this.baseDelay = options.baseDelay || 1000;
        this.maxDelay = options.maxDelay || 30000;
        this.circuitBreakerThreshold = options.circuitBreakerThreshold || 5;
        this._failureCount = 0;
        this._circuitOpen = false;
    }

    async execute(fn, options = {}) {
        const shouldRetry = options.shouldRetry || (() => true);
        const onRetry = options.onRetry || (() => {});

        for (let attempt = 0; attempt <= this.maxRetries; attempt++) {
            if (this._circuitOpen) {
                throw new Error('Circuit breaker is open');
            }

            try {
                return await fn();
            } catch (error) {
                if (attempt === this.maxRetries || !shouldRetry(error)) {
                    throw error;
                }

                this._failureCount++;
                if (this._failureCount >= this.circuitBreakerThreshold) {
                    this._circuitOpen = true;
                }

                const delay = this._calculateDelay(attempt);
                await onRetry(error, attempt, delay);
                await this._sleep(delay);
            }
        }
    }

    _calculateDelay(attempt) {
        return Math.min(this.baseDelay * Math.pow(2, attempt), this.maxDelay);
    }
}
```

### 3.3 ConnectionManager

**–§–∞–π–ª**: `public/js/managers/ConnectionManager.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```javascript
class ConnectionManager {
    constructor() {
        this.retryCount = 0;
        this.maxRetries = 5;
        this._setupListeners();
    }

    _setupListeners() {
        window.addEventListener('online', () => this._handleOnline());
        window.addEventListener('offline', () => this._handleOffline());
    }

    _handleOnline() {
        this.retryCount = 0;
        console.log('üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        document.dispatchEvent(new CustomEvent('connection:restored'));
    }

    _handleOffline() {
        console.warn('üì° –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
        document.dispatchEvent('connection:lost');
    }

    isOnline() {
        return navigator.onLine;
    }

    isOffline() {
        return !navigator.onLine;
    }

    getStatus() {
        return navigator.onLine ? 'online' : 'offline';
    }
}
```

### 3.4 AuthManager

**–§–∞–π–ª**: `public/js/managers/AuthManager.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π

```javascript
class AuthManager {
    constructor() {
        this.maxRetries = 3;
        this.isInitialized = false;
        this.pendingRequests = [];
        this._retryManager = new RetryManager({
            maxRetries: 3,
            baseDelay: 1000
        });
        this._state = 'idle'; // idle, initializing, authenticating, authenticated, error
    }

    async initialize() {
        if (this.isInitialized) return;

        this._state = 'initializing';
        
        try {
            const token = StateManager.get('authToken');
            if (token) {
                await this._verifyToken(token);
            }
            this.isInitialized = true;
            this._state = 'authenticated';
        } catch (error) {
            this._state = 'error';
            throw error;
        }
    }

    async login(credentials) {
        this._state = 'authenticating';
        
        return this._retryManager.execute(async () => {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Login failed');
            }

            const data = await response.json();
            StateManager.set('authToken', data.token);
            this._state = 'authenticated';
            
            return data;
        }, {
            shouldRetry: (error) => this._isRetryableError(error),
            onRetry: (error, attempt, delay) => {
                console.warn(`–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ ${attempt + 1}/${this.maxRetries} —á–µ—Ä–µ–∑ ${delay}ms`);
            }
        });
    }

    _isRetryableError(error) {
        return error.message.includes('ERR_CONNECTION_REFUSED') ||
               error.message.includes('NetworkError') ||
               error.message.includes('Failed to fetch');
    }

    handleConnectionError(error) {
        if (this._state === 'authenticating') {
            StateManager.set('loginAttempt', (StateManager.get('loginAttempt') || 0) + 1);
            
            if (StateManager.get('loginAttempt') >= 3) {
                StateManager.remove('loginAttempt');
                throw new Error('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }
    }
}
```

### 3.5 WebSocketManager

**–§–∞–π–ª**: `public/js/managers/WebSocketManager.js`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º

```javascript
class WebSocketManager {
    constructor() {
        this.socket = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.messageBuffer = [];
        this.subscriptions = new Map();
        this._isConnecting = false;
    }

    async connect(url) {
        if (this.socket?.readyState === WebSocket.OPEN || this._isConnecting) {
            return;
        }

        this._isConnecting = true;

        return new Promise((resolve, reject) => {
            try {
                this.socket = new WebSocket(url);

                this.socket.onopen = () => {
                    this._isConnecting = false;
                    this.reconnectAttempts = 0;
                    this._flushMessageBuffer();
                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                    resolve();
                };

                this.socket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this._handleMessage(message);
                };

                this.socket.onclose = () => {
                    this._handleDisconnect();
                };

                this.socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

                // –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                setTimeout(() => {
                    if (this.socket.readyState !== WebSocket.OPEN) {
                        this._isConnecting = false;
                        reject(new Error('WebSocket connection timeout'));
                    }
                }, 10000);

            } catch (error) {
                this._isConnecting = false;
                reject(error);
            }
        });
    }

    async reconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            throw new Error('Max reconnection attempts reached');
        }

        this.reconnectAttempts++;
        const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);
        
        await new Promise(resolve => setTimeout(resolve, delay));
        return this.connect(this.socket?.url);
    }

    bufferMessage(message) {
        this.messageBuffer.push(message);
    }

    _flushMessageBuffer() {
        while (this.messageBuffer.length > 0 && this.isConnected()) {
            const message = this.messageBuffer.shift();
            this.send(message);
        }
    }

    send(message) {
        if (this.isConnected()) {
            this.socket.send(JSON.stringify(message));
        } else {
            this.bufferMessage(message);
        }
    }
}
```

---

## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å HashStorage

### 4.1 –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π hashStorage.js

```javascript
// –í –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
import { safeInitializer } from './managers/SafeInitializer.js';

// –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º init()
async function init(options = {}) {
    return safeInitializer.initialize(async (signal) => {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (initialized) {
            console.warn('HashStorage —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            return getAll();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        await _performInit(options);
        initialized = true;
        
        return getAll();
    }, options.timeout || 30000);
}

// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—â–µ–Ω–Ω—ã–π API-–∫–ª–∏–µ–Ω—Ç
HashStorage.prototype.api = async function(endpoint, options = {}) {
    const retryManager = new RetryManager({
        maxRetries: 3,
        baseDelay: 1000
    });

    return retryManager.execute(async () => {
        const response = await fetch(`/api${endpoint}`, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                ...(this.get('authToken') && {
                    'Authorization': `Bearer ${this.get('authToken')}`
                }),
                ...options.headers
            }
        });

        if (response.status === 401) {
            // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ - –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å
            await AuthManager.refreshToken();
            throw new Error('Unauthorized - token refreshed');
        }

        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }

        return response.json();
    }, {
        shouldRetry: (error) => error.message.includes('Failed to fetch')
    });
};
```

---

## 5. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫

### 5.1 error-handler.js

```javascript
(function() {
    'use strict';

    const GlobalErrorHandler = {
        setup() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
            window.addEventListener('error', (event) => {
                this._handleError(event.error, 'window.error');
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Promise rejection
            window.addEventListener('unhandledrejection', (event) => {
                this._handleError(event.reason, 'unhandledrejection');
                event.preventDefault();
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
            window.addEventListener('offline', () => {
                this._handleConnectionLoss();
            });
        },

        _handleError(error, source) {
            console.group(`üö® Error from ${source}`);
            console.error('Error:', error);
            console.error('Stack:', error?.stack);
            console.groupEnd();

            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
            if (error?.message?.includes('ResizeObserver')) {
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            this._showNotification(error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        },

        _handleConnectionLoss() {
            this._showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è...', 'warning');
            
            document.addEventListener('connection:restored', () => {
                this._showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            }, { once: true });
        },

        _showNotification(message, type = 'info') {
            // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            if (typeof NotificationManager !== 'undefined') {
                NotificationManager.show(message, type);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
    };

    GlobalErrorHandler.setup();
    window.GlobalErrorHandler = GlobalErrorHandler;
})();
```

---

## 6. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é

### 6.1 –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω

#### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

```bash
# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
mkdir -p public/js/managers

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–¥–∞)
touch public/js/managers/ConnectionManager.js
touch public/js/managers/RetryManager.js
touch public/js/managers/SafeInitializer.js
touch public/js/managers/AuthManager.js
touch public/js/managers/WebSocketManager.js
```

#### –®–∞–≥ 2: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ app.js

```javascript
// –í –Ω–∞—á–∞–ª–æ app.js
import './managers/ConnectionManager.js';
import './managers/RetryManager.js';
import './managers/SafeInitializer.js';
import './managers/AuthManager.js';
import './managers/WebSocketManager.js';
import './error-handler.js';
```

#### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

```javascript
// –í —Ñ—É–Ω–∫—Ü–∏–∏ initApp()
async function initApp() {
    try {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        await safeInitializer.initialize(async () => {
            // 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            StateManager.restore();
            
            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (!connectionManager.isOnline()) {
                console.warn('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º');
            }
            
            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            await authManager.initialize();
            
            // 5. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
            if (authManager.isAuthenticated()) {
                await webSocketManager.connect(WS_URL);
            }
            
            // 6. –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            renderApp();
        });
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        showErrorScreen(error);
    }
}
```

#### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```javascript
// –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
runTests();
```

---

## 7. –¢–µ—Å—Ç-–∫–µ–π—Å—ã

### 7.1 Unit —Ç–µ—Å—Ç—ã

| –¢–µ—Å—Ç | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|---------------------|
| SafeInitializer: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ | –ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–∏—Å |
| RetryManager: —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å | –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å—Ä–∞–∑—É |
| RetryManager: –æ—à–∏–±–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ | 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π |
| RetryManager: circuit breaker | –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫ |
| ConnectionManager: offline | isOnline() = false |
| AuthManager: login —Å –æ—à–∏–±–∫–æ–π | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ |

### 7.2 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

| –¢–µ—Å—Ç | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|---------------------|
| –ü–æ–ª–Ω—ã–π flow –≤—Ö–æ–¥–∞ | –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥, —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω |
| –ü–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∞–≤—Ç–æ-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ |
| –ò—Å—Ç–µ–∫—à–∏–π —Ç–æ–∫–µ–Ω | –ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–ª–∏ logout |
| WS disconnect | –ê–≤—Ç–æ-–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ |

---

## 8. –í–æ–ø—Ä–æ—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 8.1 –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

1. ‚úÖ –£–¥–∞–ª–µ–Ω hardcoded API key –∏–∑ –ª–æ–≥–æ–≤
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ HTTPS –≤ production
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 8.2 –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –≤ production
2. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Ç–æ–∫–µ–Ω—ã
3. –õ–æ–≥–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
4. –ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage

---

## 9. –ì–æ—Ç–æ–≤—ã–µ —Å–Ω–∏–ø–ø–µ—Ç—ã

### 9.1 –ó–∞—â–∏—â–µ–Ω–Ω—ã–π API-–≤—ã–∑–æ–≤

```javascript
async function safeFetch(url, options = {}) {
    const retryManager = new RetryManager({ maxRetries: 3 });
    
    return retryManager.execute(async () => {
        const response = await fetch(url, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                ...options.headers
            }
        });

        if (response.status === 401) {
            await AuthManager.refreshToken();
            throw new Error('Token refreshed');
        }

        return response.json();
    });
}
```

### 9.2 –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```javascript
function setupAuthStateListener() {
    document.addEventListener('auth:statechange', (event) => {
        const { isAuthenticated, user } = event.detail;
        
        if (!isAuthenticated) {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
            window.location.hash = '#/auth';
        }
    });
}
```

---

## 10. Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–ª–æ—É–¥

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ `window.location.reload()`

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// –ë—ã–ª–æ
if (error) window.location.reload();

// –°—Ç–∞–ª–æ
if (error && !StateManager.get('reloadProtection')) {
    StateManager.set('reloadProtection', true);
    setTimeout(() => StateManager.remove('reloadProtection'), 60000);
    window.location.reload();
}
```

### –ü—Ä–æ–±–ª–µ–º–∞: ERR_CONNECTION_REFUSED

**–ü—Ä–∏—á–∏–Ω–∞**: –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–†–µ—à–µ–Ω–∏–µ**:
```javascript
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
if (!connectionManager.isOnline()) {
    throw new Error('No connection');
}
```

---

## 11. Changelog

### v1.0.0 (2024-01-31)
- –°–æ–∑–¥–∞–Ω—ã –±–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç-–∫–µ–π—Å—ã

---

## 12. –ö–æ–Ω—Ç–∞–∫—Ç—ã

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π: —Å–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
